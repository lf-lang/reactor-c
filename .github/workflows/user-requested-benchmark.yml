name: User-requested benchmarks

on:
  issue_comment:
    types: [created]
  push:  # TODO: Remove this when this is in the default branch.
  workflow_dispatch:

env:  # TODO: Do not hard-code these!
  PR_NUMBER: 91
  SCHEDULER: NP
  FEATURE_BRANCH: automated-full-benchmark

permissions:
  contents: write
  pull-requests: write

jobs:
  run_benchmarks:
    runs-on: ubuntu-latest
    name: Post benchmark results in a PR.
    steps:
      - name: Checkout benchmark repository
        uses: actions/checkout@v2
        with:
          repository: lf-lang/benchmarks-lingua-franca
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          ref: automated-full-benchmark  # FIXME: delete this line after merge

      - name: Checkout benchmarks-lingua-franca
        uses: actions/checkout@v2
        with:
          repository: lf-lang/benchmarks-lingua-franca
          token: ${{ secrets.PAT_FOR_PUSHING_BENCHMARK_RESULTS }}
          fetch-depth: 0  # It will be necessary to push to this repo
          ref: saved-benchmark-results
          path: benchmarks-lingua-franca

      - name: Set up workspace
        uses: lf-lang/reactor-c/.github/actions/set-up-workspace@automated-full-benchmark

      - name: Run Benchmarks Part 1
        id: run-benchmarks-1
        uses: lf-lang/reactor-c/.github/actions/run-benchmarks-all-runtime-versions@automated-full-benchmark
        with:
          scheduler: ${{ env.SCHEDULER }}
          feature-branch: ${{ env.FEATURE_BRANCH }}
          num-workers: 1,12

      - name: Visualize, Save, and Upload
        uses: lf-lang/reactor-c/.github/actions/visualize-save-upload@automated-full-benchmark
        with:
          csv-files: ${{ steps.run-benchmarks-1.outputs.output-files }}
          token: ${{ secrets.PAT_FOR_PUSHING_BENCHMARK_RESULTS }}
          id: 1

      - name: Run Benchmarks Part 2
        id: run-benchmarks-2
        uses: lf-lang/reactor-c/.github/actions/run-benchmarks-all-runtime-versions@automated-full-benchmark
        with:
          scheduler: ${{ env.SCHEDULER }}
          feature-branch: ${{ env.FEATURE_BRANCH }}
          num-workers: 3,6,24

      - name: Visualize, Save, and Upload
        uses: lf-lang/reactor-c/.github/actions/visualize-save-upload@automated-full-benchmark
        with:
          csv-files: "${{ steps.run-benchmarks-1.outputs.output-files }} ${{ steps.run-benchmarks-2.outputs.output-files }}"
          token: ${{ secrets.PAT_FOR_PUSHING_BENCHMARK_RESULTS }}
          id: 2

      - name: Run Benchmarks Part 3
        id: run-benchmarks-3
        uses: lf-lang/reactor-c/.github/actions/run-benchmarks-all-runtime-versions@automated-full-benchmark
        with:
          scheduler: ${{ env.SCHEDULER }}
          feature-branch: ${{ env.FEATURE_BRANCH }}
          num-workers: 2,4,9,18

      - name: Visualize, Save, and Upload
        uses: lf-lang/reactor-c/.github/actions/visualize-save-upload@automated-full-benchmark
        with:
          csv-files: "${{ steps.run-benchmarks-1.outputs.output-files }} ${{ steps.run-benchmarks-2.outputs.output-files }} ${{ steps.run-benchmarks-3.outputs.output-files }}"
          token: ${{ secrets.PAT_FOR_PUSHING_BENCHMARK_RESULTS }}
          id: 3
          finalize: true
